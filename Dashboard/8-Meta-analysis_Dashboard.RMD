---
title: "Lung tissue Meta-analysis for COPD"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    css: mystyle.css
    vertical_layout: scroll
    navbar:
      - { title: "About", href: "https://example.com/about", align: left }
runtime: shiny
---

```{r setup, include=FALSE}
library(flexdashboard)
library(knitr)
library(kableExtra)
library(tidyverse)
library(RColorBrewer)
library(metafor)
# devtools::install_github("klaukh/d3heatmap",force = T)
library(d3heatmap)
library(DT)
```


Heatmap {data-orientation=rows}
=====================================  

Inputs {.sidebar}
-----------------------------------------------------------------------


```{r}
numericInput("q_cutoff", "Q-value cutoff:", value = 0.001,
              min = 0, max = 1, step = 0.001)

numericInput("i2_cutoff", "I2 value cutoff:", value = 40,
              min = 0, max = 100, step = 5)

numericInput("numexp_cutoff", "Number of minimum experiments:", value = 5,
              min = 0, max = 100, step = 5)


```

    

Row
-------------------------------------
    
### Experiments in the Meta-analysis

    
```{r}
gse_table <- read.csv("2020-10-07_Step3_Summary.csv", row.names = 1)
kable(gse_table, caption = "GSE information") %>%
   kable_styling()
```

   
Row {.tabset .tabset-fade}
-------------------------------------

### Heatmap {data-height=1200}


```{r}
# Data
full_tables <- read_csv("2020-10-08_Step5_Full_Tables.csv")
meta <- read_csv("2020-10-16_Step6_meta-analysis.csv")[,-1]
# View(meta %>% filter(qval < 0.5,I2 < 40,num_exp > 5))


FC <- str_subset(colnames(full_tables),"logFC")

# Heatmap
genesqval <-  reactive({
  meta %>% filter(qval <= input$q_cutoff, 
                  I2 <= input$i2_cutoff, 
                  num_exp >= input$numexp_cutoff)
})

topgenes <- reactive({
  data.frame(full_tables[which(full_tables$GENE.SYMBOL %in% genesqval()$genes),FC], 
                   row.names = genesqval()$genes)
})


#rownames(topgenes) <- genesqval$genes
  
renderD3heatmap({
  d3heatmap::d3heatmap(topgenes(),
            #Rowv = FALSE, #Colv=FALSE,
            col = rev(brewer.pal(3,"RdBu")),
            scale = "column",
            na.color = "#cfcccc")
})
```


### Q-values

  
```{r}
renderPlot({
  hist(genesqval()$qval, probability = TRUE, breaks = 30,
       xlab = "q-values", main = "Adjusted p-values")
  
  dens <- density(genesqval()$qval)
  lines(dens, col = "blue")
})
```



### Tau2

  
```{r}

renderPlot({
  hist(genesqval()$tau2, probability = TRUE, breaks = 30,
       xlab = "tau2 values", main = "Tau2")
  
  dens <- density(genesqval()$qval)
  lines(dens, col = "red")
})
```



### I2

  
```{r}

renderPlot({
  hist(genesqval()$I2, probability = TRUE, breaks = 30,
       xlab = "I2 %", main = "Measure of heterogeneity by I2")
  
  dens <- density(genesqval()$qval)
  lines(dens, col = "red")
})
```



Gene {data-orientation=rows}
=====================================  

### Table of genes {data-height=300}

```{r}

output$gen <- DT::renderDataTable(
meta,
selection = 'single'
)
DT::dataTableOutput('gen')

```

Row
-------------------------------------

### Forest plot {data-height=1000}


```{r}

CI.R <- str_subset(colnames(full_tables),"CI.R")
CI.L <- str_subset(colnames(full_tables),"CI.L")

for(i in 1:length(CI.R)) {
  full_tables[str_c("SE_",gsub(".*_","",CI.R))] <- (full_tables[,CI.R]-full_tables[,CI.L]) /(2*1.96)
}

SE <- str_subset(colnames(full_tables),"SE_")
GSE <- gsub(".*_","",FC)

meta.plot <- function(gs){
gene <-  full_tables[full_tables$GENE.SYMBOL == gs,]
#gene <-  na.omit(full_tables[full_tables$GENE.SYMBOL == gs,])
gene <- gene[!is.na(gene$GENE.SYMBOL),]

yi <- as.numeric(gene[,FC])
sei <- as.numeric(gene[,SE])

# meta analysis in the simplest way
res <- metafor::rma(yi, sei=sei)
par(mfrow=c(2,1))
forest(res,slab = GSE, main=unique(gene$GENE.SYMBOL),psize = 1.8,cex = 1.8)
funnel(res,psize = 1.8,cex = 1.8)
}

renderPlot({
  gene =  as.character(meta[input$gen_rows_selected,"genes"])
  meta.plot(gene)
})

```


