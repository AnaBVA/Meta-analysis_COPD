---
title: "2: Normalizing data"
author: Ana BVA
date: "`r BiocStyle::doc_date()`"
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
editor_options: 
  chunk_output_type: console
---

## Introduction

<div class="alert alert-info">
  <strong>Aim:</strong> To normalize raw data
</div>

### Background 

Some relevant information with links [GEO](https://www.ncbi.nlm.nih.gov/geo/)


## Input

This script needs the following files:

<div class="alert alert-warning">
  <strong>Data:</strong> Raw data (e.i. .CEL, .TXT)  
  <strong>2-Table_GSE-info.txt:</strong> Table with GSE IDs and platform description 
</div>



## Setup

For running the script, type:

```{bash, eval = F}
ssh -X aaltamirano@dna.lavis.unam.mx
qrsh
cd /mnt/Genoma/amedina/aaltamirano/COPD/Meta-analysis_COPD/output_data/.out
 module load r/4.0.1 

nohup R -e "rmarkdown::render(here::here('vignettes/2-normalizing-data.RMD'))" > 2-normalizing-data.out &
```

The script can be found in: `r getwd() `. And the directories were set using
`R/setup.R` (e.i. DATA, OUPUT, DOWNLOAD) as a small functions that will paste the names into complete paths.

```{r setup}
knitr::opts_knit$set(root.dir = here::here())
source(here::here("R/setup.R"))
```

And this analysis is run in: `r getwd() `

### Libraries

```{r libraries, message=FALSE, warning=FALSE}
library(limma)
library(tidyverse)
```


## Functions


### **rawCEL_normCEL**: Pre-process raw data for Affymetrix 

We first read and pre-process raw *.CEL* files. Each experiment has it own 
folder with raw data per sample. Then we normalized using RMA algorithm and 
finally, we save it. 

In this function you need:

<div class="alert alert-warning">
  <strong>Input:</strong> GSE ID   
  <hr>
  <strong>Output:</strong>  
  - Samples normalized  
  - Boxplots  
  - Histograms 
</div>


```{r rawCEL_normCEL}
rawCEL_normCEL <- function(gse){
  # select and untar files
  gsepath <- file.path(here::here("GEOquery"),gse)
  untar(list.files(gsepath,full.names=T), exdir=gsepath)
  # for CEL files "AFFYMETRIX"
  if(any(grepl("cel",list.files(gsepath),ignore.case = T))){
    celfiles <- list.celfiles(gsepath)
    # read CEL files in R
    rawData <- ReadAffy(celfile.path = gsepath)
    #### Figures of raw data
    #pdf(str_c("raw_",gse,"_boxplot",TODAY,".pdf"))
    ## plots of raw data
    boxplot(rawData,target="core")
    hist(rawData,target="core")
    #dev.off()
    ## RMA normalization
    normData <- rma(rawData)
    #### Figures of Normalized data
    #pdf(str_c("norm_",gse,"_boxplot",TODAY,".pdf"))
    ## `plots of norm data
    boxplot(normData)
    hist(normData)
    # dev.off()
    #write.csv(exprs(normData),str_c("/normalized",gse,"_normData",TODAY,".tx  t"),quote=F)
    return(normData)
  }
  #for TXT files "AGILENT"
  else if(any(grepl("txt",list.files(gsepath),ignore.case = T))){
    files <- list.files(gsepath,full.names=T, pattern = "txt")
    # read agilent files
    RG <- read.maimages(files[1:5],source = "agilent.median",green.only=T)
    #plots: raw data
    boxplot(RG$E)
    hist(RG$E)
    # normalizing data
    RG <- backgroundCorrect(RG, method="normexp", offset=1)
    RG$E <- normalizeBetweenArrays(RG$E, method="quantile")
    RG$E <- log2(RG$E)
    #plots: norm
    hist(RG$E)
    boxplot(RG$E)
    return(RG)
  }
  # anyother case
  else{
    print("This is not Affymetrix or Agilent")
  }
}

#sapply(tissue,rawCEL_normCEL)

```





## Analysis

We had selected this experiments and downloaded raw data using srcripts:

- 0: Data selection `/0-Data-selection.RMD`

- 1: Dowload RAW data `/1-download_raw-data.RMD`


```{r}
gse_table <- read_tsv(DATA("2-Table_GSE-info.txt"))
knitr::kable(gse_table, caption = "GSE information")
```

### STEP 1: GEOquery information

We read GEOquery data for all the experiments 

```{r}
geo <- readRDS(OUTPUT(c(TODAY,"_GEOquery-download.RDS")))
```


### STEP 2: Normalizing raw data

Normalize raw data

```{r}
geo_norm <- sapply(gse_table$Accession,rawCEL_normCEL)
```


## Output

This script produces the following data, and can be found in `r getwd() ` 

<div class="alert alert-success">
  <strong>Figure 1:</strong> Boxplot of samples  
  <strong>Figure 2:</strong> Heatmap of COPD patients 
</div>

## Session Info

```{r sessionInfo}
sessionInfo()
```





